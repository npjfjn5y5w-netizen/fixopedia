<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waypoint EXAMPLE | Fixipedia</title>
    <meta name="description" content="Details and name origin for aviation waypoint EXAMPLE.">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="container">
        <h1><a href="index.html" style="color:white;">Fixipedia</a></h1>
        <p>Aviation Waypoint Name Origins</p>
    </div>
</header>

<main class="container">

    <section id="waypoint-detail">
        <h2>Waypoint: EXAMPLE</h2>
        <button id="backButton" type="button">← Back to results</button>

        <div class="detail-grid">
            <div>
                <p><strong>State:</strong> <span id="wpState"></span></p>
                <p><strong>Associated Airport:</strong> <span id="wpAirport"></span></p>
                <p><strong>Procedure Type:</strong> <span id="wpProcType"></span></p>
                <p><strong>Procedure Name:</strong> <span id="wpProcName"></span></p>
                <p><strong>Latitude:</strong> <span id="wpLat"></span></p>
                <p><strong>Longitude:</strong> <span id="wpLon"></span></p>

            </div>

            <div>
                <p><strong>Raw Coordinates:</strong> <span id="wpCoordText"></span></p>

            </div>
        </div>
    </section>

    <section id="origin">
        <h2>Name Origin</h2>
        <p id="wpOrigin"></p>

    </section>

    <section id="related">
        <h2>Related Waypoints</h2>
        <ul>
            <li><a href="waypoint.html?name=BRAVO">BRAVO</a></li>
            <li><a href="waypoint.html?name=CHARLIE">CHARLIE</a></li>
            <li><a href="waypoint.html?name=DELTA">DELTA</a></li>
        </ul>
    </section>

</main>

<footer>
    <div class="container">
        <p>&copy; 2025 Fixipedia</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ---- Supabase setup ----
  const SUPABASE_URL = "https://jobycjifggynmfszpdto.supabase.co";
  const SUPABASE_ANON_KEY = "PASTE_YOUR_ANON_KEY_HERE"; // same anon key you used in script.js
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Back button
  const backButton = document.getElementById("backButton");
  if (backButton) {
    backButton.addEventListener("click", () => {
      window.location.href = "index.html#search";
    });
  }

  // Read params (prefer id, fallback to name)
  const params = new URLSearchParams(window.location.search);
  const id = (params.get("id") || "").trim();
  const nameParam = (params.get("name") || "").trim().toUpperCase();

  // Helpers
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value ?? "";
  };

  const heading = document.querySelector("#waypoint-detail h2");

  function setHeadingTitle(displayName) {
    if (displayName) {
      document.title = `Waypoint ${displayName} | Fixipedia`;
      if (heading) heading.textContent = `Waypoint: ${displayName}`;
    } else {
      document.title = "Waypoint | Fixipedia";
      if (heading) heading.textContent = "Waypoint";
    }
  }

  async function loadFromSupabase() {
    // If we have a fixipedia_id, use that (best)
    if (id) {
      const { data, error } = await supabaseClient
        .from("waypoints")
        .select("fixipedia_id, name, state, latitude, longitude")
        .eq("fixipedia_id", id)
        .limit(1);

      if (error) throw error;
      return data?.[0] || null;
    }

    // Fallback: name (can return multiple)
    if (nameParam) {
      const { data, error } = await supabaseClient
        .from("waypoints")
        .select("fixipedia_id, name, state, latitude, longitude")
        .eq("name", nameParam)
        .limit(25);

      if (error) throw error;
      return data || [];
    }

    return null;
  }

  async function loadCuratedFromJson(nameUpper) {
    // Your curated file has waypoint/procedure/origin fields
    // (Small file, ok to keep for now)
    try {
      const res = await fetch("./waypoints.json");
      if (!res.ok) return null;
      const waypoints = await res.json();

      return waypoints.find(w => String(w.waypoint || "").trim().toUpperCase() === nameUpper) || null;
    } catch {
      return null;
    }
  }

  function showDisambiguation(list) {
    // Multiple same-name fixes exist. Show a simple chooser.
    setHeadingTitle(nameParam);
    setText("wpOrigin", "Multiple fixes share this name. Pick the correct one below:");

    const related = document.querySelector("#related ul");
    if (!related) return;

    related.innerHTML = list.map(r => {
      const label = `${r.name} (${r.latitude ?? "?"}, ${r.longitude ?? "?"})`;
      return `<li><a href="waypoint.html?id=${encodeURIComponent(r.fixipedia_id)}">${label}</a></li>`;
    }).join("");
  }

  async function renderWaypoint() {
    if (!id && !nameParam) {
      setHeadingTitle("");
      setText("wpOrigin", "No waypoint specified. Open like: waypoint.html?id=FIXIPEDIA_ID (or ?name=ABCDE).");
      return;
    }

    // 1) Pull FAA fields from Supabase
    let supa = null;
    try {
      const result = await loadFromSupabase();

      // If fallback by name returned a list:
      if (Array.isArray(result)) {
        if (result.length === 0) {
          setHeadingTitle(nameParam);
          setText("wpOrigin", "No Supabase record found for this name.");
          return;
        }
        if (result.length > 1) {
          showDisambiguation(result);
          return;
        }
        supa = result[0];
      } else {
        supa = result;
      }
    } catch (err) {
      console.error("Supabase load failed:", err);
      setText("wpOrigin", "Could not load from Supabase. Check console (F12).");
      return;
    }

    if (!supa) {
      setHeadingTitle(nameParam || "");
      setText("wpOrigin", "No Supabase record found.");
      return;
    }

    // Set title/heading
    setHeadingTitle(supa.name);

    // Fill Supabase fields
    setText("wpState", supa.state || "");
    setText("wpLat", supa.latitude ?? "");
    setText("wpLon", supa.longitude ?? "");
    setText("wpCoordText", (supa.latitude != null && supa.longitude != null) ? `${supa.latitude}, ${supa.longitude}` : "");

    // 2) Pull curated “origin/procedure/airport” from your JSON (if it exists)
    const curated = await loadCuratedFromJson(supa.name);

    setText("wpAirport", curated?.airport || "");
    setText("wpProcType", curated?.procedure_type || "");
    setText("wpProcName", curated?.procedure_name || "");
    setText("wpOrigin", curated?.origin || "No origin story added yet.");

    // 3) Related list: if you want, keep your static links for now,
    // but we can generate real related results later.
  }

  renderWaypoint();
</script>




</body>
</html>
